name: Local CI

on:
  pull_request:
  workflow_dispatch:

env:
  # The path to the GeoIPS package in images
  BASE_GEOIPS_PATH: /packages/geoips

  # Tag to use for plugin repos (they pull an existing GeoIPS image)
  PLUGIN_DEV_TAG: dev-stable

  # Dockerfile target to build
  DOCKER_BUILD_TARGET: dev

defaults:
  run:
    shell: bash

jobs:
  build-and-test:
    runs-on: ${{ vars.RUNNER }}
    env:
      CURR_REPO: ${{ github.event.repository.name }}
      DOCKER_REGISTRY: ${{ vars.DOCKER_REGISTRY }}
      DOCKER_REGISTRY_USER: ${{ vars.DOCKER_REGISTRY_USER }}

      # New flag to disable registry operations - defaults to 'false' (disabled)
      ENABLE_DOCKER_REGISTRY: ${{ vars.ENABLE_DOCKER_REGISTRY }}

      # Buildx disabled by default - set to 'true' to enable
      USE_DOCKER_BUILDX_ACTION: ${{ vars.USE_DOCKER_BUILDX_ACTION }}

      # Optional: set this org/repo variable to point at your testdata source.
      # Examples:
      #   - Local dir in repo: ./geoips_testdata
      #   - Git URL (BuildKit): git://github.com/NRLMMD-GEOIPS/geoips_testdata.git#main
      #   - OCI image (BuildKit): docker-image://ghcr.io/<org>/<image>:<tag>
      TESTDATA_BUILD_CONTEXT: ${{ vars.TESTDATA_BUILD_CONTEXT }}
    permissions:
      contents: read
      packages: write

    steps:
      #########################################
      # SETUP AND DEBUG
      #########################################
      - name: Debug - Print initial environment
        run: |
          echo "::group::Initial Environment"
          echo "============================================"
          echo "SYSTEM INFORMATION"
          echo "============================================"
          echo "Hostname: $(hostname)"
          echo "User: $(whoami)"
          echo "Working Directory: $(pwd)"
          echo "Home Directory: $HOME"
          echo ""
          echo "============================================"
          echo "GITHUB CONTEXT"
          echo "============================================"
          echo "Repository: ${{ github.repository }}"
          echo "Current Repo Name: $CURR_REPO"
          echo "Ref: $GITHUB_REF"
          echo "SHA: $GITHUB_SHA"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Default Branch: ${{ github.event.repository.default_branch }}"
          echo ""
          echo "============================================"
          echo "RUNNER INFORMATION"
          echo "============================================"
          echo "Runner OS: ${{ runner.os }}"
          echo "Runner Name: ${{ runner.name }}"
          echo "Runner: ${{ vars.RUNNER }}"
          echo "Runner Docker Build: ${{ vars.RUNNER_DOCKERBUILD }}"
          echo "Runner Docker Run: ${{ vars.RUNNER_DOCKERRUN }}"
          echo ""
          echo "============================================"
          echo "CONFIGURATION VARIABLES"
          echo "============================================"
          echo "Docker Registry: $DOCKER_REGISTRY"
          echo "Docker Registry User: $DOCKER_REGISTRY_USER"
          echo "Enable Docker Registry: ${ENABLE_DOCKER_REGISTRY:-false (default)}"
          echo "Use Docker Buildx: ${USE_DOCKER_BUILDX_ACTION:-false (default)}"
          echo "Upload Artifacts: ${{ vars.UPLOAD_GITHUB_ARTIFACTS }}"
          echo ""
          echo "CI Flags:"
          echo "  CI_BUILD_SPHINX_HTML: ${{ vars.CI_BUILD_SPHINX_HTML }}"
          echo "  CI_BUILD_SPHINX_PDF: ${{ vars.CI_BUILD_SPHINX_PDF }}"
          echo "  CI_TEST_INTERFACES: ${{ vars.CI_TEST_INTERFACES }}"
          echo "  CI_TEST_PYTEST_SHORT: ${{ vars.CI_TEST_PYTEST_SHORT }}"
          echo ""
          echo "Testdata build context (vars.TESTDATA_BUILD_CONTEXT): ${TESTDATA_BUILD_CONTEXT:-<not set>}"
          echo "::endgroup::"

      - name: Debug - Check installed software
        run: |
          echo "::group::Installed Software Versions"
          echo "Git: $(git --version)"
          echo "Docker: $(docker --version 2>&1 || echo 'Docker not installed')"
          echo "Python: $(python3 --version 2>&1 || echo 'Python not installed')"
          echo "Pip: $(pip3 --version 2>&1 || echo 'Pip not installed')"
          echo ""
          echo "Docker Info:"
          docker info 2>&1 || echo "Cannot get docker info"
          echo ""
          echo "Docker Images:"
          docker images 2>&1 || echo "Cannot list docker images"
          echo "::endgroup::"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - Repository contents
        run: |
          echo "::group::Repository Contents"
          echo "Repository root contents:"
          ls -la
          echo ""
          echo "Git status:"
          git status
          echo ""
          echo "Git log (last 5 commits):"
          git log --oneline -5
          echo ""
          echo "Git remote:"
          git remote -v
          echo ""
          if [ -f "Dockerfile" ]; then
            echo "Dockerfile exists - first 30 lines:"
            head -30 Dockerfile
          else
            echo "WARNING: Dockerfile not found!"
          fi
          echo "::endgroup::"

      - name: Configure Git safe directory
        run: |
          git config --global --add safe.directory $PWD
          echo "Git safe directory configured: $PWD"

      #########################################
      # SET TESTDATA CONTEXT (needed for --mount from=testdata)
      #########################################
      - name: Determine BuildKit testdata context
        id: set_testdata
        if: ${{ github.event.repository.name == 'geoips' }}
        run: |
          echo "::group::Determining BuildKit testdata context"

          # If user provided an explicit context via vars, use it.
          if [ -n "${TESTDATA_BUILD_CONTEXT}" ]; then
            echo "Using TESTDATA_BUILD_CONTEXT from vars: ${TESTDATA_BUILD_CONTEXT}"
            echo "FINAL_TESTDATA_CONTEXT=${TESTDATA_BUILD_CONTEXT}" >> "$GITHUB_ENV"
            echo "FINAL_TESTDATA_CONTEXT=${TESTDATA_BUILD_CONTEXT}" >> "$GITHUB_OUTPUT"
            echo "::endgroup::"
            exit 0
          fi

          # Otherwise try common local directories in the repo.
          if [ -d "./geoips_testdata" ]; then
            echo "Found local directory ./geoips_testdata - using it as testdata build context"
            echo "FINAL_TESTDATA_CONTEXT=./geoips_testdata" >> "$GITHUB_ENV"
            echo "FINAL_TESTDATA_CONTEXT=./geoips_testdata" >> "$GITHUB_OUTPUT"
            echo "::endgroup::"
            exit 0
          fi

          if [ -d "./testdata" ]; then
            echo "Found local directory ./testdata - using it as testdata build context"
            echo "FINAL_TESTDATA_CONTEXT=./testdata" >> "$GITHUB_ENV"
            echo "FINAL_TESTDATA_CONTEXT=./testdata" >> "$GITHUB_OUTPUT"
            echo "::endgroup::"
            exit 0
          fi

          echo "::error::No testdata build context configured, but Dockerfile uses: --mount=type=bind,from=testdata"
          echo "BuildKit will otherwise try to pull an image named 'testdata:latest' (and fail)."
          echo ""
          echo "Fix options:"
          echo "  1) Set Actions variable TESTDATA_BUILD_CONTEXT to a local path or git URL, e.g.:"
          echo "       ./geoips_testdata"
          echo "       git://github.com/NRLMMD-GEOIPS/geoips_testdata.git#main"
          echo "  2) Update the Dockerfile to not require 'from=testdata' for the dev target."
          echo ""
          echo "Repository root listing:"
          ls -la
          exit 1

      #########################################
      # SET JOB FLAGS AND IMAGE NAMES
      #########################################
      - name: Set CI job flags
        id: set_flags
        run: |
          echo "::group::Setting CI Flags"

          flags=(CI_BUILD_SPHINX_HTML \
                 CI_BUILD_SPHINX_PDF \
                 CI_TEST_INTERFACES \
                 CI_TEST_PYTEST_SHORT)

          for flag in "${flags[@]}"; do
              case $flag in
                  CI_BUILD_SPHINX_HTML) val="${{ vars.CI_BUILD_SPHINX_HTML }}" ;;
                  CI_BUILD_SPHINX_PDF) val="${{ vars.CI_BUILD_SPHINX_PDF }}" ;;
                  CI_TEST_INTERFACES) val="${{ vars.CI_TEST_INTERFACES }}" ;;
                  CI_TEST_PYTEST_SHORT) val="${{ vars.CI_TEST_PYTEST_SHORT }}" ;;
              esac

              if [ "$val" == "false" ]; then
                  echo "${flag}=false"
                  echo "${flag}=false" >> $GITHUB_ENV
                  echo "${flag}=false" >> $GITHUB_OUTPUT
              else
                  echo "${flag}=true"
                  echo "${flag}=true" >> $GITHUB_ENV
                  echo "${flag}=true" >> $GITHUB_OUTPUT
              fi
          done

          echo "::endgroup::"

      - name: Set Docker image names
        id: set_images
        run: |
          echo "::group::Setting Docker Image Names"

          repo_name=$(echo ${{ github.repository }} | cut -d'/' -f2)
          echo "Repository Name: ${repo_name}"
          echo "REPO_NAME=${repo_name}" >> $GITHUB_ENV
          echo "REPO_NAME=${repo_name}" >> $GITHUB_OUTPUT

          # Set base image name
          if [ -n "$DOCKER_REGISTRY_USER" ]; then
            image_name=${DOCKER_REGISTRY_USER}/geoips
          else
            image_name=geoips
          fi
          echo "Base Image Name: ${image_name}"
          echo "IMAGE_NAME=${image_name}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${image_name}" >> $GITHUB_OUTPUT

          if [[ "${CURR_REPO}" == "geoips" ]]; then
              dev_tag="dev-${GITHUB_SHA}"
              echo "GeoIPS repository detected - building new image"
          else
              dev_tag="${PLUGIN_DEV_TAG}"
              echo "Plugin repository detected - using existing image"
          fi

          echo "Dev Tag: ${dev_tag}"
          echo "DEV_TAG=${dev_tag}" >> $GITHUB_ENV
          echo "DEV_TAG=${dev_tag}" >> $GITHUB_OUTPUT

          dev_image="${image_name}:${dev_tag}"
          echo "Dev Image: ${dev_image}"
          echo "DEV_IMAGE=${dev_image}" >> $GITHUB_ENV
          echo "DEV_IMAGE=${dev_image}" >> $GITHUB_OUTPUT

          buildcache_image="${image_name}:buildcache"
          echo "Build Cache Image: ${buildcache_image}"
          echo "BUILDCACHE_IMAGE=${buildcache_image}" >> $GITHUB_ENV
          echo "BUILDCACHE_IMAGE=${buildcache_image}" >> $GITHUB_OUTPUT

          # Build full image paths - only include registry if ENABLE_DOCKER_REGISTRY is true
          if [ "${ENABLE_DOCKER_REGISTRY}" == "true" ] && [ -n "$DOCKER_REGISTRY" ]; then
            FULL_DEV_IMAGE="${DOCKER_REGISTRY}/${repo_name}/${dev_image}"
            FULL_BUILDCACHE_IMAGE="${DOCKER_REGISTRY}/${repo_name}/${buildcache_image}"
            echo "Registry enabled - using full paths with registry"
          else
            FULL_DEV_IMAGE="${dev_image}"
            FULL_BUILDCACHE_IMAGE="${buildcache_image}"
            echo "Registry disabled - using local image names only"
          fi

          echo "Full Dev Image: ${FULL_DEV_IMAGE}"
          echo "Full Build Cache Image: ${FULL_BUILDCACHE_IMAGE}"
          echo "FULL_DEV_IMAGE=${FULL_DEV_IMAGE}" >> $GITHUB_ENV
          echo "FULL_BUILDCACHE_IMAGE=${FULL_BUILDCACHE_IMAGE}" >> $GITHUB_ENV

          echo "::endgroup::"

      - name: Print final configuration
        run: |
          echo "::group::Final Configuration Summary"
          echo "============================================"
          echo "JOB FLAGS"
          echo "============================================"
          echo "Build Sphinx HTML: ${{ steps.set_flags.outputs.CI_BUILD_SPHINX_HTML }}"
          echo "Build Sphinx PDF: ${{ steps.set_flags.outputs.CI_BUILD_SPHINX_PDF }}"
          echo "Test Interfaces: ${{ steps.set_flags.outputs.CI_TEST_INTERFACES }}"
          echo "Test Pytest Short: ${{ steps.set_flags.outputs.CI_TEST_PYTEST_SHORT }}"
          echo ""
          echo "============================================"
          echo "IMAGE CONFIGURATION"
          echo "============================================"
          echo "Repository Name: ${{ steps.set_images.outputs.REPO_NAME }}"
          echo "Base Image Name: ${{ steps.set_images.outputs.IMAGE_NAME }}"
          echo "Dev Tag: ${{ steps.set_images.outputs.DEV_TAG }}"
          echo "Dev Image: ${{ steps.set_images.outputs.DEV_IMAGE }}"
          echo "Build Cache Image: ${BUILDCACHE_IMAGE}"
          echo "Full Dev Image: ${FULL_DEV_IMAGE}"
          echo "Full Build Cache Image: ${FULL_BUILDCACHE_IMAGE}"
          echo ""
          echo "============================================"
          echo "DOCKER BUILD CONFIGURATION"
          echo "============================================"
          echo "DOCKER_BUILD_TARGET: ${DOCKER_BUILD_TARGET}"
          echo "USE_DOCKER_BUILDX_ACTION: ${USE_DOCKER_BUILDX_ACTION:-false (default)}"
          echo "ENABLE_DOCKER_REGISTRY: ${ENABLE_DOCKER_REGISTRY:-false (default)}"
          echo "DOCKER_REGISTRY: ${DOCKER_REGISTRY:-<not set>}"
          echo "DOCKER_REGISTRY_USER: ${DOCKER_REGISTRY_USER:-<not set>}"
          echo ""
          if [[ "${{ github.event.repository.name }}" == "geoips" ]]; then
            echo "FINAL_TESTDATA_CONTEXT: ${FINAL_TESTDATA_CONTEXT:-<not set>}"
          fi
          echo "::endgroup::"

      #########################################
      # BUILD DOCKER IMAGE (if geoips repo)
      #########################################
      - name: Setup Docker Buildx
        if: ${{ github.event.repository.name == 'geoips' && vars.USE_DOCKER_BUILDX_ACTION == 'true' }}
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Registry (GeoIPS repo)
        if: ${{ github.event.repository.name == 'geoips' && vars.ENABLE_DOCKER_REGISTRY == 'true' }}
        env:
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          DOCKER_TOKEN_LOWER: ${{ secrets.docker_token }}
        run: |
          echo "::group::Docker Registry Login"

          echo "Registry operations enabled - logging in..."
          echo "Registry: ${{ env.DOCKER_REGISTRY }}"
          echo "Username: ${{ env.DOCKER_REGISTRY_USER }}"
          echo ""

          if [ -n "${DOCKER_TOKEN}" ]; then
            echo "Using DOCKER_TOKEN secret"
            if [ -n "$DOCKER_REGISTRY" ]; then
              echo "${DOCKER_TOKEN}" | docker login $DOCKER_REGISTRY -u $DOCKER_REGISTRY_USER --password-stdin
            else
              echo "${DOCKER_TOKEN}" | docker login -u $DOCKER_REGISTRY_USER --password-stdin
            fi
          elif [ -n "${DOCKER_TOKEN_LOWER}" ]; then
            echo "Using docker_token secret"
            if [ -n "$DOCKER_REGISTRY" ]; then
              echo "${DOCKER_TOKEN_LOWER}" | docker login $DOCKER_REGISTRY -u $DOCKER_REGISTRY_USER --password-stdin
            else
              echo "${DOCKER_TOKEN_LOWER}" | docker login -u $DOCKER_REGISTRY_USER --password-stdin
            fi
          else
            echo "::error::No Docker token found in secrets"
            exit 1
          fi

          echo "::endgroup::"

      - name: Skip Registry Login
        if: ${{ github.event.repository.name == 'geoips' && vars.ENABLE_DOCKER_REGISTRY != 'true' }}
        run: |
          echo "::group::Docker Registry Login"
          echo "⚠️  Registry operations are DISABLED (default)"
          echo "Skipping Docker registry login"
          echo "::endgroup::"

      - name: Cache Docker layers
        if: ${{ github.event.repository.name == 'geoips' }}
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Determine image tags
        if: ${{ github.event.repository.name == 'geoips' }}
        id: set_tags
        run: |
          echo "::group::Determining Image Tags"

          tags="${FULL_DEV_IMAGE},${FULL_BUILDCACHE_IMAGE}"

          if [[ "${GITHUB_REF}" == "refs/heads/${{ github.event.repository.default_branch }}" ]]; then
            stableorlatest_tag="dev-stable"
            echo "On default branch - adding stable tag"
          elif [[ "${GITHUB_REF}" == "refs/tags/"* ]]; then
            stableorlatest_tag="dev-stable"
            echo "On tag - adding stable tag"
          else
            stableorlatest_tag="dev-latest"
            echo "On feature branch - adding latest tag"
          fi

          stableorlatest_image="${IMAGE_NAME}:${stableorlatest_tag}"

          if [ "${ENABLE_DOCKER_REGISTRY}" == "true" ] && [ -n "$DOCKER_REGISTRY" ]; then
            FULL_STABLEORLATEST_IMAGE="${DOCKER_REGISTRY}/${REPO_NAME}/${stableorlatest_image}"
          else
            FULL_STABLEORLATEST_IMAGE="${stableorlatest_image}"
          fi

          tags="${tags},${FULL_STABLEORLATEST_IMAGE}"

          echo "All tags: ${tags}"
          echo "PUSH_TAGS=${tags}" >> $GITHUB_ENV
          echo "STABLEORLATEST_IMAGE=${stableorlatest_image}" >> $GITHUB_ENV
          echo "FULL_STABLEORLATEST_IMAGE=${FULL_STABLEORLATEST_IMAGE}" >> $GITHUB_ENV

          echo "::endgroup::"

      #########################################
      # DOCKER BUILD - EXPLICIT DOCKER COMMAND (DEFAULT)
      #
      # IMPORTANT: Dockerfile uses:
      #   RUN --mount=type=bind,from=testdata,...
      # So we MUST provide a BuildKit build context named "testdata".
      #########################################
      - name: Build Docker image (explicit docker build - DEFAULT)
        if: ${{ github.event.repository.name == 'geoips' && vars.USE_DOCKER_BUILDX_ACTION != 'true' }}
        run: |
          echo "::group::Building Docker Image"

          echo "Using explicit 'docker build' command (default method)"
          echo ""
          echo "Building image with tags:"
          echo "  1. ${FULL_DEV_IMAGE}"
          echo "  2. ${FULL_BUILDCACHE_IMAGE}"
          echo "  3. ${FULL_STABLEORLATEST_IMAGE}"
          echo ""
          echo "Docker target: ${DOCKER_BUILD_TARGET}"
          echo "BuildKit testdata context: ${FINAL_TESTDATA_CONTEXT}"

          # Ensure BuildKit is used (required for --build-context and RUN --mount)
          export DOCKER_BUILDKIT=1

          docker build \
            --file Dockerfile \
            --tag "${FULL_DEV_IMAGE}" \
            --tag "${FULL_BUILDCACHE_IMAGE}" \
            --tag "${FULL_STABLEORLATEST_IMAGE}" \
            --target "${DOCKER_BUILD_TARGET}" \
            --build-context "testdata=${FINAL_TESTDATA_CONTEXT}" \
            --progress=plain \
            .

          echo "::endgroup::"

      - name: List built Docker images
        if: ${{ github.event.repository.name == 'geoips' && vars.USE_DOCKER_BUILDX_ACTION != 'true' }}
        run: |
          echo "::group::Built Docker Images"
          docker images
          docker system df
          echo "::endgroup::"

      - name: Push Docker images to registry
        if: ${{ github.event.repository.name == 'geoips' && vars.USE_DOCKER_BUILDX_ACTION != 'true' && vars.ENABLE_DOCKER_REGISTRY == 'true' }}
        run: |
          echo "::group::Pushing Docker Images"
          docker push ${FULL_BUILDCACHE_IMAGE}
          docker push ${FULL_DEV_IMAGE}
          docker push ${FULL_STABLEORLATEST_IMAGE}
          echo "::endgroup::"

      - name: Skip pushing to registry
        if: ${{ github.event.repository.name == 'geoips' && vars.USE_DOCKER_BUILDX_ACTION != 'true' && vars.ENABLE_DOCKER_REGISTRY != 'true' }}
        run: |
          echo "::group::Pushing Docker Images"
          echo "⚠️  Registry operations are DISABLED (default)"
          echo "Skipping push to Docker registry"
          echo "::endgroup::"

      #########################################
      # DOCKER BUILD - BUILDX ACTION
      # (also must pass build context testdata=...)
      #########################################
      - name: Build and push Docker image (buildx with registry)
        if: ${{ github.event.repository.name == 'geoips' && vars.USE_DOCKER_BUILDX_ACTION == 'true' && vars.ENABLE_DOCKER_REGISTRY == 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          target: ${{ env.DOCKER_BUILD_TARGET }}
          push: true
          tags: ${{ env.PUSH_TAGS }}
          file: "Dockerfile"
          build-contexts: |
            testdata=${{ env.FINAL_TESTDATA_CONTEXT }}
          cache-from: type=registry,ref=${{ env.BUILDCACHE_IMAGE }}
          cache-to: type=registry,ref=${{ env.FULL_BUILDCACHE_IMAGE }},mode=max

      - name: Build Docker image (buildx local only)
        if: ${{ github.event.repository.name == 'geoips' && vars.USE_DOCKER_BUILDX_ACTION == 'true' && vars.ENABLE_DOCKER_REGISTRY != 'true' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          target: ${{ env.DOCKER_BUILD_TARGET }}
          push: false
          load: true
          tags: ${{ env.PUSH_TAGS }}
          file: "Dockerfile"
          build-contexts: |
            testdata=${{ env.FINAL_TESTDATA_CONTEXT }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move buildx cache
        if: ${{ github.event.repository.name == 'geoips' && vars.USE_DOCKER_BUILDX_ACTION == 'true' && vars.ENABLE_DOCKER_REGISTRY != 'true' }}
        run: |
          echo "Moving buildx cache..."
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache || echo "No new cache to move"

      #########################################
      # PULL DOCKER IMAGE (for plugin repos)
      #########################################
      - name: Use local Docker image (for plugin repos - registry disabled)
        if: ${{ github.event.repository.name != 'geoips' && vars.ENABLE_DOCKER_REGISTRY != 'true' }}
        run: |
          echo "::group::Using Local Docker Image"

          echo "⚠️  Registry operations are DISABLED (default)"
          echo "This is a plugin repository - checking for local image"
          echo ""
          echo "Looking for image: ${FULL_DEV_IMAGE}"
          echo ""

          if docker image inspect ${FULL_DEV_IMAGE} >/dev/null 2>&1; then
            echo "✓ Image found locally"
            docker images | grep -E "REPOSITORY|${FULL_DEV_IMAGE}" || true
          else
            echo "::warning::Image not found locally: ${FULL_DEV_IMAGE}"
            echo "Available local images:"
            docker images
            echo ""
            echo "To use this workflow with a plugin repo when registry is disabled,"
            echo "you need to either:"
            echo "  1. Build the geoips image first on this runner, or"
            echo "  2. Enable registry operations (ENABLE_DOCKER_REGISTRY=true)"
          fi

          echo "::endgroup::"

      - name: Pull Docker image (for plugin repos - registry enabled)
        if: ${{ github.event.repository.name != 'geoips' && vars.ENABLE_DOCKER_REGISTRY == 'true' }}
        env:
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          DOCKER_TOKEN_LOWER: ${{ secrets.docker_token }}
        run: |
          echo "::group::Pulling Docker Image"

          echo "Registry operations enabled - pulling image from registry"
          echo "Image to pull: ${FULL_DEV_IMAGE}"
          echo ""

          echo "Logging in to registry for image pull..."
          if [ -n "${DOCKER_TOKEN}" ]; then
            if [ -n "$DOCKER_REGISTRY" ]; then
              echo "${DOCKER_TOKEN}" | docker login $DOCKER_REGISTRY -u $DOCKER_REGISTRY_USER --password-stdin
            else
              echo "${DOCKER_TOKEN}" | docker login -u $DOCKER_REGISTRY_USER --password-stdin
            fi
          elif [ -n "${DOCKER_TOKEN_LOWER}" ]; then
            if [ -n "$DOCKER_REGISTRY" ]; then
              echo "${DOCKER_TOKEN_LOWER}" | docker login $DOCKER_REGISTRY -u $DOCKER_REGISTRY_USER --password-stdin
            else
              echo "${DOCKER_TOKEN_LOWER}" | docker login -u $DOCKER_REGISTRY_USER --password-stdin
            fi
          else
            echo "::warning::No Docker token found - attempting anonymous pull"
          fi

          docker pull ${FULL_DEV_IMAGE}

          echo "::endgroup::"

      #########################################
      # TEST ENVIRONMENT SETUP
      #########################################
      - name: Test Docker image
        run: |
          echo "::group::Testing Docker Image"

          echo "Testing basic image functionality..."
          echo "Image: ${FULL_DEV_IMAGE}"
          echo ""

          echo "Test 1: Check Python version"
          docker run --rm ${FULL_DEV_IMAGE} python3 --version
          echo ""

          echo "Test 2: Check pip version"
          docker run --rm ${FULL_DEV_IMAGE} pip3 --version
          echo ""

          echo "Test 3: Check GeoIPS base path"
          docker run --rm ${FULL_DEV_IMAGE} ls -la ${BASE_GEOIPS_PATH} || echo "Base GeoIPS path not found"
          echo ""

          echo "Test 4: Check installed packages"
          docker run --rm ${FULL_DEV_IMAGE} pip list

          echo "::endgroup::"

      #########################################
      # BUILD DOCUMENTATION
      #########################################
      - name: Build Sphinx HTML Documentation
        if: ${{ steps.set_flags.outputs.CI_BUILD_SPHINX_HTML == 'true' }}
        id: build_html_docs
        run: |
          echo "::group::Building Sphinx HTML Documentation"

          run_on_package=$CURR_REPO
          if [[ "$CURR_REPO" == "template_basic_plugin" ]]; then
            run_on_package=my_package
            echo "Template detected - using package name: my_package"
          else
            echo "Using package name: ${run_on_package}"
          fi

          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            -e BASE_GEOIPS_PATH=${BASE_GEOIPS_PATH} \
            ${FULL_DEV_IMAGE} \
            bash -c "
              set -e
              pip install -v .
              python3 ${BASE_GEOIPS_PATH}/docs/build_docs.py \
                --geoips-docs-path ${BASE_GEOIPS_PATH}/docs/ \
                --force \
                --repo-path /workspace \
                ${run_on_package}
            "

          if [ -d "build/sphinx/html" ]; then
            echo "✓ HTML documentation built successfully"
            echo "BUILT_DOCS_PATH=$PWD/build/sphinx/html" >> $GITHUB_OUTPUT
          else
            echo "::error::HTML documentation directory not found"
            ls -la build/ || true
            exit 1
          fi

          echo "::endgroup::"

      #########################################
      # CODE TESTING - INTERFACES
      #########################################
      - name: Test Interfaces
        if: ${{ steps.set_flags.outputs.CI_TEST_INTERFACES == 'true' }}
        run: |
          echo "::group::Testing Interfaces"

          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            -e BASE_GEOIPS_PATH=${BASE_GEOIPS_PATH} \
            ${FULL_DEV_IMAGE} \
            bash -c "
              set -e
              pip install -v -e .
              create_plugin_registries
              python ${BASE_GEOIPS_PATH}/tests/utils/test_interfaces.py
            "

          echo "::endgroup::"

      #########################################
      # CODE TESTING - PYTEST
      #########################################
      - name: Run Pytest Unit Tests (Repository-specific)
        if: ${{ steps.set_flags.outputs.CI_TEST_PYTEST_SHORT == 'true' }}
        run: |
          echo "::group::Running Repository Pytest Unit Tests"

          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            -e BASE_GEOIPS_PATH=${BASE_GEOIPS_PATH} \
            -e CURR_REPO=${CURR_REPO} \
            ${FULL_DEV_IMAGE} \
            bash -c "
              set -e
              pip install -v -e .
              create_plugin_registries

              if [ ! -d './tests' ]; then
                echo 'No tests directory found - skipping repository-specific tests'
                exit 0
              fi

              pytest -vv
            "

          echo "::endgroup::"

      - name: Run Pytest Unit Tests (Core GeoIPS)
        if: ${{ steps.set_flags.outputs.CI_TEST_PYTEST_SHORT == 'true' && github.event.repository.name != 'geoips' }}
        run: |
          echo "::group::Running Core GeoIPS Pytest Unit Tests"

          docker run --rm \
            -v $(pwd):/workspace \
            -w /workspace \
            -e BASE_GEOIPS_PATH=${BASE_GEOIPS_PATH} \
            ${FULL_DEV_IMAGE} \
            bash -c "
              set -e
              pip install -v -e .
              create_plugin_registries
              pytest -vv ${BASE_GEOIPS_PATH}/tests
            "

          echo "::endgroup::"

      #########################################
      # FINAL CLEANUP AND SUMMARY
      #########################################
      - name: Cleanup Docker resources
        if: always()
        run: |
          echo "::group::Cleanup Docker Resources"
          docker system df
          docker system prune -f
          docker system df
          echo "::endgroup::"

      - name: CI Summary
        if: always()
        run: |
          echo "::group::CI Pipeline Summary"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${GITHUB_REF}"
          echo "SHA: ${GITHUB_SHA}"
          echo "Target: ${DOCKER_BUILD_TARGET}"
          if [[ "${{ github.event.repository.name }}" == "geoips" ]]; then
            echo "BuildKit testdata context: ${FINAL_TESTDATA_CONTEXT:-<not set>}"
          fi
          echo "::endgroup::"
